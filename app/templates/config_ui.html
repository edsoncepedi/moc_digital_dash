<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Configuração de Postos</title>

<style>
body { font-family: Arial; margin: 30px; }
.row { display: grid; grid-template-columns: 220px 1fr; gap: 10px; margin: 10px 0; max-width: 520px; }
input, select, button { padding: 8px; font-size: 14px; }
button { cursor: pointer; }
.card { border: 1px solid #ddd; border-radius: 10px; padding: 20px; max-width: 600px; }
.status { margin-top: 15px; padding: 10px; border-radius: 8px; }
.ok { background: #eaffea; border: 1px solid #b6f2b6; }
.err { background: #ffecec; border: 1px solid #ffbdbd; }
</style>
</head>

<body>

<h2>Configuração de Postos</h2>

<div class="card">

<div class="row">
<label>Posto</label>
<select id="posto">
<option value="0">Posto 0</option>
<option value="1">Posto 1</option>
<option value="2">Posto 2</option>
</select>
</div>

<div class="row"><label>ROI_X</label><input id="ROI_X" type="number"></div>
<div class="row"><label>ROI_Y</label><input id="ROI_Y" type="number"></div>
<div class="row"><label>ROI_W</label><input id="ROI_W" type="number"></div>
<div class="row"><label>ROI_H</label><input id="ROI_H" type="number"></div>
<div class="row"><label>CONFIDENCE_THRESHOLD</label><input id="CONFIDENCE_THRESHOLD" type="number" step="0.01" min="0" max="1"></div>

<div style="margin-top: 15px;">
<button onclick="carregar()">Carregar</button>
<button onclick="salvar()">Salvar</button>
</div>

<div id="status" class="status" style="display:none;"></div>

</div>

<script>
const campos = ["ROI_X","ROI_Y","ROI_W","ROI_H","CONFIDENCE_THRESHOLD"];

function status(msg, ok=true){
    const el = document.getElementById("status");
    el.style.display = "block";
    el.className = "status " + (ok ? "ok" : "err");
    el.innerText = msg;
}

function postoAtual(){
    return document.getElementById("posto").value;
}

function preencher(data){
    campos.forEach(c => {
        if(data[c] !== undefined){
            document.getElementById(c).value = data[c];
        }
    });
}

function lerForm(){
    return {
        ROI_X: parseInt(ROI_X.value),
        ROI_Y: parseInt(ROI_Y.value),
        ROI_W: parseInt(ROI_W.value),
        ROI_H: parseInt(ROI_H.value),
        CONFIDENCE_THRESHOLD: parseFloat(CONFIDENCE_THRESHOLD.value)
    };
}

async function carregar(){
    const posto = postoAtual();
    status("Carregando...");

    try{
        const r = await fetch(`/api/config/${posto}`);
        const data = await r.json();
        preencher(data);
        status("Config carregada com sucesso.");
    }catch(e){
        status("Erro ao carregar.", false);
    }
}

async function salvar(){
    const posto = postoAtual();
    const payload = lerForm();

    status("Salvando...");

    try{
        const r = await fetch(`/api/config/${posto}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        if(!r.ok){
            const err = await r.json();
            status("Erro: " + (err.detail || "falha"), false);
            return;
        }

        status("Salvo com sucesso!");
    }catch(e){
        status("Erro ao salvar.", false);
    }
}

document.getElementById("posto").addEventListener("change", carregar);

carregar();
</script>

</body>
</html>